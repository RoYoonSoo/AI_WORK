import glob
import os

import pandas as pd
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix


# =========================================================
# --- 5. ì˜ˆì¸¡ í‰ê°€ í•¨ìˆ˜ ì •ì˜ (âœ… ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„) ---
# =========================================================
def evaluate_predictions():
    print("ğŸ“Š Dì—´(ì •ë‹µ)ê³¼ Eì—´(ì˜ˆì¸¡)ì„ ë¹„êµí•˜ì—¬ ëª¨ë¸ ì„±ëŠ¥ì„ í‰ê°€í•©ë‹ˆë‹¤...")

    data_folder = 'data'
    file_paths = glob.glob(os.path.join(data_folder, '**', '*.*'), recursive=True)
    file_paths = [f for f in file_paths if os.path.isfile(f) and not os.path.basename(f).startswith('.')]

    if not file_paths:
        print("âš ï¸ í‰ê°€í•  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    all_dfs = []
    for p in file_paths:
        try:
            # skiprows=1: ì²« ë²ˆì§¸ í–‰(í—¤ë”)ì€ ê±´ë„ˆë›°ê³  ì½ìŒ
            if p.endswith('.csv'):
                all_dfs.append(pd.read_csv(p, header=None, skiprows=1))
            elif p.endswith('.xlsx'):
                all_dfs.append(pd.read_excel(p, header=None, skiprows=1))
        except Exception as e:
            print(f"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {p}, ì˜¤ë¥˜: {e}")

    if not all_dfs:
        print("âš ï¸ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        return

    combined_df = pd.concat(all_dfs, ignore_index=True)

    # Dì—´(3) ë˜ëŠ” Eì—´(4)ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° í‰ê°€ ì¤‘ë‹¨
    if 3 not in combined_df.columns or 4 not in combined_df.columns:
        print("âŒ í‰ê°€ì— í•„ìš”í•œ Dì—´ ë˜ëŠ” Eì—´ì´ ëª¨ë“  íŒŒì¼ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    # Dì—´ ë˜ëŠ” Eì—´ì— ë°ì´í„°ê°€ ì—†ëŠ” í–‰ì€ í‰ê°€ì—ì„œ ì œì™¸
    combined_df.dropna(subset=[3, 4], inplace=True)

    if combined_df.empty:
        print("âš ï¸ ë¹„êµí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Dì—´ê³¼ Eì—´ì— ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # ë°ì´í„° íƒ€ì…ì„ ë¬¸ìì—´ë¡œ í†µì¼í•˜ê³  ê³µë°± ì œê±°
    y_true = combined_df[3].astype(str).str.strip()
    y_pred = combined_df[4].astype(str).str.strip()

    # --- 1. ì •í™•ë„ (Accuracy) ---
    # ì‚¬ìš©ìê°€ ìš”ì²­í•œ 'Dì—´ê³¼ Eì—´ì´ ê°™ì€ ë¹„ìœ¨'
    accuracy = accuracy_score(y_true, y_pred)
    print("\n" + "=" * 50)
    print(f"### 1. ì „ì²´ ì •í™•ë„ (Accuracy) ###")
    print(f"Dì—´ê³¼ Eì—´ì˜ ë¼ë²¨ì´ ì¼ì¹˜í•˜ëŠ” ë¹„ìœ¨ì€ ì•½ {accuracy:.2%} ì…ë‹ˆë‹¤.")
    print(f"(ì´ {len(y_true)}ê°œì˜ ë°ì´í„° ì¤‘ {int(accuracy * len(y_true))}ê°œ ì¼ì¹˜)")
    print("=" * 50)

    # --- 2. ë¶„ë¥˜ ë¦¬í¬íŠ¸ (Classification Report) ---
    # ê° ë¼ë²¨ë³„ ì •ë°€ë„, ì¬í˜„ìœ¨, F1 ì ìˆ˜ë¥¼ ë³´ì—¬ì¤Œ
    print("\n" + "=" * 50)
    print("### 2. ìƒì„¸ ë¶„ë¥˜ ë¦¬í¬íŠ¸ ###")
    print("ì •ë°€ë„(Precision): ëª¨ë¸ì´ 'A'ë¼ê³  ì˜ˆì¸¡í•œ ê²ƒ ì¤‘ ì‹¤ì œ 'A'ì¸ ë¹„ìœ¨")
    print("ì¬í˜„ìœ¨(Recall)   : ì‹¤ì œ 'A'ì¸ ê²ƒë“¤ ì¤‘ ëª¨ë¸ì´ 'A'ë¼ê³  ë§ì¶˜ ë¹„ìœ¨")
    print("F1-Score         : ì •ë°€ë„ì™€ ì¬í˜„ìœ¨ì˜ ì¡°í™” í‰ê·  (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ)")
    print("-" * 50)

    # ë¼ë²¨ ìˆœì„œë¥¼ ì •í•˜ê¸° ìœ„í•´ ê³ ìœ  ë¼ë²¨ ëª©ë¡ ì¶”ì¶œ
    labels = sorted(pd.concat([y_true, y_pred]).unique())
    report = classification_report(y_true, y_pred, labels=labels, zero_division=0)
    print(report)
    print("=" * 50)

    # --- 3. í˜¼ë™ í–‰ë ¬ (Confusion Matrix) ---
    # ëª¨ë¸ì´ ì–´ë–¤ ë¼ë²¨ì„ ì–´ë–¤ ë¼ë²¨ë¡œ í˜¼ë™í•˜ëŠ”ì§€ ë³´ì—¬ì¤Œ
    print("\n" + "=" * 50)
    print("### 3. í˜¼ë™ í–‰ë ¬ (Confusion Matrix) ###")
    print("í–‰(ì„¸ë¡œ): ì‹¤ì œ ì •ë‹µ ë¼ë²¨, ì—´(ê°€ë¡œ): ëª¨ë¸ì˜ ì˜ˆì¸¡ ë¼ë²¨")
    print("-" * 50)
    cm = confusion_matrix(y_true, y_pred, labels=labels)
    cm_df = pd.DataFrame(cm, index=[f"ì‹¤ì œ: {l}" for l in labels], columns=[f"ì˜ˆì¸¡: {l}" for l in labels])
    print(cm_df)
    print("\n(ì˜ˆ: 'ì‹¤ì œ: ì¹­ì°¬' í–‰ì˜ 'ì˜ˆì¸¡: ë¹„íŒ' ì—´ ê°’ì´ 10ì´ë¼ë©´, ì‹¤ì œ 'ì¹­ì°¬'ì¸ ëŒ“ê¸€ 10ê°œë¥¼ 'ë¹„íŒ'ìœ¼ë¡œ ì˜ëª» ì˜ˆì¸¡í–ˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.)")
    print("=" * 50)

# =========================================================
# ---                 ë©”ì¸ ì½”ë“œ ì‹¤í–‰ ë¶€ë¶„                 ---
# =========================================================
if __name__ == "__main__":
    # 1ë‹¨ê³„: ë¼ë²¨ë§ ê²°ê³¼ í‰ê°€ (Dì—´ vs Eì—´)
    print("========================================")
    print("### 3ë‹¨ê³„: ì˜ˆì¸¡ ê²°ê³¼ í‰ê°€ ì‹œì‘ ###")
    print("========================================")
    evaluate_predictions()
    print("\n\n")