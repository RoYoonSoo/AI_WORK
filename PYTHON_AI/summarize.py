import pandas as pd
from transformers import pipeline
import os
import glob

# --- âš™ï¸ ì„¤ì • ë¶€ë¶„ ---

# 'comments_'ë¡œ ì‹œì‘í•˜ê³  '.csv'ë¡œ ëë‚˜ëŠ” ëª¨ë“  íŒŒì¼ì„ ì°¾ì•„ì„œ ì •ë ¬í•©ë‹ˆë‹¤.
# ì´ë ‡ê²Œ í•˜ë©´ comments_1.csv, comments_2.csv, ... ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
FILE_PATHS = sorted(glob.glob("data/comments_*.csv"))
RESULT_DIR = "results"
RESULT_FILE = os.path.join(RESULT_DIR, "full_summary.txt")

# 1ï¸âƒ£ ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
print("ğŸ”„ ìš”ì•½ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...")
# KoBART: í•œì¤„ ìš”ì•½ìš©
summarizer = pipeline("summarization", model="gogamza/kobart-summarization")
print("âœ… ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!")


# 2ï¸âƒ£ íšŒì°¨ë³„ ìš”ì•½ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜ (sentiment ë¶€ë¶„ ì œê±°)
def generate_summary_input_text(episode_df):
    """
    ìš”ì•½ ëª¨ë¸ì— ë„£ê¸° ì¢‹ì€ í˜•íƒœë¡œ íšŒì°¨ë³„ í…ìŠ¤íŠ¸ë¥¼ ê°€ê³µí•©ë‹ˆë‹¤.
    """
    # ì¢‹ì•„ìš” ë§ì´ ë°›ì€ ìƒìœ„ 3ê°œ ëŒ“ê¸€ ì„ íƒ (ëŒ“ê¸€ì´ 3ê°œ ë¯¸ë§Œì¼ ê²½ìš°ë„ ì²˜ë¦¬)
    top_n = min(3, len(episode_df))
    if top_n == 0:
        return "ì´ íšŒì°¨ì—ëŠ” ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."

    top_comments = episode_df.nlargest(top_n, 'likes')['comment'].tolist()
    top_comments_text = ". ".join(top_comments)

    # ìš”ì•½ ëª¨ë¸ì— ì…ë ¥í•  ìµœì¢… í…ìŠ¤íŠ¸ ìƒì„±
    full_text = f"ì´ íšŒì°¨ì˜ ì£¼ìš” ë°˜ì‘ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: {top_comments_text}."
    return full_text


# 3ï¸âƒ£ íšŒì°¨ë³„ ìš”ì•½ ë° ì „ì²´ ìš”ì•½ ìƒì„± (í•µì‹¬ ë¡œì§ ìˆ˜ì •)
episode_summaries = []

# íŒŒì¼ ëª©ë¡ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
if FILE_PATHS:
    print("\n--- ğŸš€ íšŒì°¨ë³„ ìš”ì•½ ì‹œì‘ ---")
    # íŒŒì¼ì„ í•˜ë‚˜ì”© ìˆœíšŒí•˜ë©° ìš”ì•½ ì§„í–‰
    for i, path in enumerate(FILE_PATHS):
        episode_num = i + 1
        print(f"\nâ³ {episode_num}íšŒì°¨ ({os.path.basename(path)}) ëŒ“ê¸€ ìš”ì•½ ì¤‘...")

        try:
            # í˜„ì¬ íšŒì°¨(íŒŒì¼)ì˜ ëŒ“ê¸€ë§Œ ì½ê¸°
            # 1, 3, 4ë²ˆì§¸ ì—´ë§Œ ì½ê³ , ë°”ë¡œ ìƒˆ ì´ë¦„ ë¶€ì—¬
            episode_df = pd.read_csv(
                path,
                encoding='utf-8-sig',
                header=None,
                skiprows=1,
                usecols=[0, 2, 3],
                names=['comment', 'likes', 'dislikes']
            )

            # íŒŒì¼ì€ ìˆì§€ë§Œ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸°
            if episode_df.empty:
                print(f"âš ï¸ {episode_num}íšŒì°¨({os.path.basename(path)}) íŒŒì¼ì— ë‚´ìš©ì´ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤.")
                continue

            # 1. ìš”ì•½í•  í…ìŠ¤íŠ¸ ìƒì„±
            input_text = generate_summary_input_text(episode_df)

            # 2. ëª¨ë¸ì„ í†µí•´ ìš”ì•½ (max_length -> max_new_tokens ë¡œ ë³€ê²½)
            summary = summarizer(input_text, max_new_tokens=60, min_new_tokens=10, do_sample=False)[0]["summary_text"]
            episode_summaries.append(summary)

            # 3. íšŒì°¨ë³„ ìš”ì•½ ê²°ê³¼ ì¶œë ¥
            print(f"âœ… {episode_num}íšŒì°¨ í•œ ì¤„ ìš”ì•½: {summary}")

        except Exception as e:
            print(f"âŒ '{path}' íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    # 4ï¸âƒ£ ì „ì²´ ìš”ì•½ ë° íŒŒì¼ ì €ì¥
    if episode_summaries:
        print("\n--- ğŸš€ ì „ì²´ ìš”ì•½ ì‹œì‘ ---")
        # 1. íšŒì°¨ë³„ ìš”ì•½ë“¤ì„ í•©ì³ì„œ ì „ì²´ ìš”ì•½ì˜ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©
        overall_input_text = " ".join(episode_summaries)

        # 2. ì „ì²´ ë‚´ìš© ìš”ì•½ (max_length -> max_new_tokens ë¡œ ë³€ê²½)
        print("â³ ëª¨ë“  íšŒì°¨ì˜ ë‚´ìš©ì„ ì¢…í•©í•˜ì—¬ ìš”ì•½ ì¤‘...")
        overall_summary = summarizer(overall_input_text, max_new_tokens=100, min_new_tokens=20, do_sample=False)[0][
            "summary_text"]

        # 3. ìµœì¢… ê²°ê³¼ ì¶œë ¥
        print("\nğŸ‰ ìµœì¢… ìš”ì•½ ê²°ê³¼ì…ë‹ˆë‹¤! ğŸ‰")
        print("---")
        for i, summary in enumerate(episode_summaries):
            print(f"ğŸ“„ {i + 1}íšŒì°¨: {summary}")
        print("---")
        print(f"âœ¨ ì „ì²´: {overall_summary}")

        # 5. íŒŒì¼ë¡œ ì €ì¥
        if not os.path.exists(RESULT_DIR):
            os.makedirs(RESULT_DIR)

        with open(RESULT_FILE, "w", encoding="utf-8") as f:
            f.write("--- íšŒì°¨ë³„ í•œ ì¤„ ìš”ì•½ ---\n")
            for i, summary in enumerate(episode_summaries):
                f.write(f"{i + 1}íšŒì°¨: {summary}\n")
            f.write("\n--- ì „ì²´ ì¢…í•© ìš”ì•½ ---\n")
            f.write(overall_summary)

        print(f"\nâœ… ì „ì²´ ìš”ì•½ ê²°ê³¼ê°€ '{RESULT_FILE}' íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        print("âš ï¸ ìš”ì•½ëœ ë‚´ìš©ì´ ì—†ì–´ ì „ì²´ ìš”ì•½ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
else:
    print("âš ï¸ ì²˜ë¦¬í•  'comments_*.csv' íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ì´ë¦„ê³¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")

